{% extends "cosinnus_poll/base.html" %}
{% load i18n static cosinnus_tags widget_tweaks %}

{% block page_title %}
{% trans "Vote" context "the_verb" %}
{{ block.super }}
{% endblock page_title %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="active">
    {% blocktrans with title=poll.title %}Vote for {{ title }}{% endblocktrans %}
  </li>
{% endblock %}

{% block leftnav %}
    {% include "cosinnus_poll/leftnav.html" with return_to="doodle" %}
{% endblock leftnav %}

{% block content %}
    
    <div class="clearfix large-space"> 
	    <!-- a box with semi transparent background -->
		<div class="content-box">
	       
	        {% include "cosinnus_poll/single_poll_detailed.html" with poll=poll hide_control_buttons="True" %}
	
	        <div class="doodle-vote-table">
	            {% if poll.state == 2 %}
	                <!--{% trans "This poll has been completed. Voting is closed." %}-->
	                {% include 'cosinnus/common/empty_button.html' with message="This poll has been completed. Voting is closed." %}
	            {% elif poll.state == 3 %}
	                <!--{% trans "This is an archived poll." %}-->
	                {% include 'cosinnus/common/empty_button.html' with message="This is an archived poll." %}
	            {% endif %}
	            
	            {% if options %}
		            <!-- width = n*54-4 -->
		            {% if not votes_user_grouped %}
	                    <div>
	                        <!--{% trans "Nobody has voted for this poll poll yet." %}-->
	                        {% include 'cosinnus/common/empty_button.html' with message="Nobody has voted for this doodle yet." %}
	                    </div>
		            {% endif %}
		            
		            <div>
		                <div></div>
		                {% for options in options_grouped %}
				            <div class="doodle-vote-date" style="min-width: {{options|length|multiply:54|subtract:4}}px;" title="{{ options.0.from_date|date:COSINNUS_DJANGO_DATETIME_FORMAT }}">
			                    &nbsp;{{ options.0.from_date|date:"D" }}<br/>&nbsp;{{ options.0.from_date|date:COSINNUS_DJANGO_DATE_SHORT_CLEAR_FORMAT }}
			                </div>
				        {% endfor %}
		            </div>
		
		            <div>
		                <div></div>
		                {% for options in options_grouped %}
		                    {% for option in options %} 
			                    <div class="doodle-vote-time">
				                    &nbsp;{{ option.from_date|date:COSINNUS_DJANGO_TIME_FORMAT }}
				                </div>
			                {% endfor %}
		                {% endfor %}
		            </div>
		
		            {% for user, votes in votes_user_grouped.items %}
		                <div>
			                <div>
			                    {% include "cosinnus/user/user_avatar_image.html" with user=votes.0.voter %}
			                </div>
			                {% for vote in votes %}
			                    {% if vote.choice == 2 %}
			                        <div class="doodle-vote-yes" title="{% trans 'Yes' %}">
					                    <i class="fa fa-check"></i>
					                </div>
			                    {% elif vote.choice == 1 %}
		                            <div class="doodle-vote-maybe" title="{% trans 'Maybe' %}">
					                    (<i class="fa fa-check"></i>)
					                </div>
		                        {% else %}
		                            <div class="doodle-vote-no" title="{% trans 'No' %}">
					                    <i class="fa fa-times"></i>
					                </div>
		                        {% endif %}
			                {% endfor %}
		                </div>
		            {% endfor %}
		
		            <div>
		                <div>
		                    <i class="fa fa-check" title="{% trans 'Yes' %}"></i><br />
		                    (<i class="fa fa-check" title="{% trans 'Maybe' %}"></i>)<br />
		                    <i class="fa fa-times" title="{% trans 'No' %}"></i>
		                </div>
		                {% for vote_counts in vote_counts_grouped %}
		                    {% for count in vote_counts %} 
				                <div>
				                    {% if count.3 %}<strong>{% endif %}{{ count.2 }}{% if count.3 %}</strong>{% endif %}<br />
				                    {{ count.1 }}<br />
				                    {{ count.0 }}
				                </div>
				            {% endfor %}
				        {% endfor %}
		            </div>
		            
		            {% if user|has_write_access:poll %}
			            <h2>{% trans "Create an poll from one of the options" %}</h2>
				            <div>
				                <div></div>
				                {% for options in options_grouped %}
			                        {% for option in options %} 
				                        <div>
								            <form action="{% group_url 'cosinnus:poll:complete' group=group slug=poll.slug option_id=option.pk %}" method="post" class="form-horizontal">
					                        {% csrf_token %}
					                        {{ formset.management_form }}
							                    <button type="submit" class="doodle-vote-pollbutton" title="{% blocktrans %}Set the date to {{ option }}.{% endblocktrans %}">
		                                            <i class="fa fa-bar-chart"></i>
		                                        </button>
				                            </form>
	                                    </div>
			                        {% endfor %}
			                    {% endfor %}
				            </div>
		            {% endif %}
		            
		            {% if user.is_authenticated %}
			            <h2>{% trans "When do you have time?" %}</h2>
			            
			            <!-- width = n*54-4 -->
			            <div>
			                <div></div>
			                {% for options in options_grouped %}
			                    <div class="doodle-vote-date" style="min-width: {{options|length|multiply:54|subtract:4}}px;" title="{{ options.0.from_date|date:COSINNUS_DJANGO_DATETIME_FORMAT }}">
			                        &nbsp;{{ options.0.from_date|date:"D" }}<br/>&nbsp;{{ options.0.from_date|date:COSINNUS_DJANGO_DATE_SHORT_CLEAR_FORMAT }}
			                    </div>
			                {% endfor %}
			            </div>
			
			            <div>
			                <div></div>
			                {% for options in options_grouped %}
			                    {% for option in options %} 
			                        <div class="doodle-vote-time">
			                            &nbsp;{{ option.from_date|date:COSINNUS_DJANGO_TIME_FORMAT }}
			                        </div>
			                    {% endfor %}
			                {% endfor %}
			            </div>
			            
					    <form id="cosinnus_vote_form" action="" method="post" class="form-horizontal">
					    {% csrf_token %}
					    {{ formset.management_form }}
		            
				            <div class="doodle-vote-inputarea">
				                
				                <div>
				                    {% include "cosinnus/user/user_avatar_image.html" with user=request.user %}
				                </div>
				                {% for forms in formset_forms_grouped %}
				                    {% for form in forms %}
				                        {% captureas choice_word %}{% if form.choice.value == 2 %}yes{% elif form.choice.value == 1 %}maybe{% else %}no{% endif %}{% endcaptureas %}
				                        {{ form.option.as_widget }}
				                        <div class="doodle-vote-{{choice_word}}">
							                <a href="#" data-doodle-option="yes">{% if form.choice.value == 2 %}<strong>{% endif %}{% trans "Yes" %}{% if form.choice.value == 2 %}</strong>{% endif %}</a>
							                <a href="#" data-doodle-option="maybe">{% if form.choice.value == 1 %}<strong>{% endif %}{% trans "Maybe" %}{% if form.choice.value == 1 %}</strong>{% endif %}</a>
							                <a href="#" data-doodle-option="no">{% if form.choice.value == 0 %}<strong>{% endif %}{% trans "No" %}{% if form.choice.value == 0 %}</strong>{% endif %}</a>
							                <input type="hidden" id="id_{{ form.choice.html_name }}" name="{{ form.choice.html_name }}" value="{{ form.choice.value }}" />
							            </div>
			                            
				                    {% endfor %}
				                {% endfor %}
				            </div>
		                </form>
	                {% endif %}
		            
	            {% else %}
	                {% comment %} No options were added {% endcomment %}
	                <!-- {% trans "There are no options for this poll yet!" %} -->
	                {% include 'cosinnus/common/empty_button.html' with message="There are no options for this poll yet!" %}
	            {% endif %}
	        </div><!-- table -->
	
	    </div><!-- content-box -->
	
	    {% if mode == 'vote' %}
	      <button type="submit" class="btn btn-emphasized" onclick="$('#cosinnus_vote_form').submit(); return false;">
	        <ul class="media-list">
	          <li class="media">
	            <a class="pull-left" href="#">
	              <i class="fa fa-floppy-o"></i>
	            </a>
	            <div class="media-body">
	              {% trans "Vote" %}
	            </div>
	          </li>
	        </ul>
	      </button>
	    {% endif %}
	    
			
		{% if user|has_write_access:poll %}
			  {% captureas modal_id %}deleteModal_{{poll.slug}}{% endcaptureas %}
			  <button type="button" class="btn btn-emphasized" data-toggle="modal" data-target="#{{modal_id}}">
			    <ul class="media-list">
			      <li class="media">
			        <a class="pull-left" href="#">
			          <i class="fa fa-eraser"></i>
			        </a>
			        <div class="media-body">
			          {% trans "Delete" %}
			        </div>
			      </li>
			    </ul>
			  </button>
			  
			  {% captureas label %}{% blocktrans with title=poll.title %}Do you really want to delete poll „{{ title }}“?{% endblocktrans %}{% endcaptureas %}
			  {% captureas title %}{% trans "Delete poll" %}{% endcaptureas %}
			  {% captureas action %}{% group_url 'cosinnus:poll:delete' group=group slug=poll.slug%}{% endcaptureas %}
			
			  {% include "cosinnus/modal_box.html" with id=modal_id label=label title=title form_action=action %}
			  
			  
			  <button type="button" class="btn btn-emphasized" href="{% group_url "cosinnus:poll:edit" group=group slug=poll.slug %}">
			    <ul class="media-list">
			      <li class="media">
			        <a class="pull-left" href="#">
			          <i class="fa fa-pencil"></i>
			        </a>
			        <div class="media-body">
			          {% trans "Edit" %}
			        </div>
			      </li>
			    </ul>
			  </button>
			  
			  {% if poll.state == 1 %}
		        <button type="button" class="btn btn-emphasized" href="{% group_url "cosinnus:poll:complete" group=group slug=poll.slug %}">
		            <ul class="media-list">
		                <li class="media">
		                    <a class="pull-left" href="#">
		                        <i class="fa fa-pencil"></i>
		                    </a>
		                    <div class="media-body">
		                        {% trans "Close Poll" %}
		                    </div>
		                </li>
		            </ul>
		        </button> 
	          {% elif poll.state == 2 %}
		        {% captureas reopen_modal_id %}reopenModal_{{poll.slug}}{% endcaptureas %}
		        <button type="button" class="btn btn-emphasized" data-toggle="modal" data-target="#{{reopen_modal_id}}">
		            <ul class="media-list">
		                <li class="media">
		                    <a class="pull-left" href="#">
		                        <i class="fa fa-eraser"></i>
		                    </a>
		                    <div class="media-body">
		                        {% trans "Re-open" %}
		                    </div>
		                </li>
		            </ul>
		        </button> 
		        {% captureas archive_modal_id %}archiveModal_{{poll.slug}}{% endcaptureas %}
		        <button type="button" class="btn btn-emphasized" data-toggle="modal" data-target="#{{archive_modal_id}}">
		            <ul class="media-list">
		                <li class="media">
		                    <a class="pull-left" href="#">
		                        <i class="fa fa-eraser"></i>
		                    </a>
		                    <div class="media-body">
		                        {% trans "Archive" %}
		                    </div>
		                </li>
		            </ul>
		        </button>
		        
		    	{% captureas label %}{% blocktrans with title=poll.title %}Do you really want to re-open poll „{{ title }}“?{% endblocktrans %}{% endcaptureas %}
			    {% captureas title %}{% trans "Re-open poll" %}{% endcaptureas %}
			    {% captureas action %}{% group_url 'cosinnus:poll:reopen' group=group slug=poll.slug %}{% endcaptureas %}
			    {% include "cosinnus/modal_box.html" with id=reopen_modal_id label=label title=title form_action=action %}
			    
			    {% captureas label %}{% blocktrans with title=poll.title %}Do you really want to archive poll „{{ title }}“?{% endblocktrans %}{% endcaptureas %}
			    {% captureas title %}{% trans "Archive poll" %}{% endcaptureas %}
			    {% captureas action %}{% group_url 'cosinnus:poll:archive' group=group slug=poll.slug %}{% endcaptureas %}
			    {% include "cosinnus/modal_box.html" with id=archive_modal_id label=label title=title form_action=action %}
	        {% endif %}
		  
		{% endif %}
		
		
    	{% include 'cosinnus/feedback/report_button_btn.html' with object=poll %}
		
	</div> <!-- buttons and content box -->
	
	{% include 'cosinnus_poll/poll_comments.html' with poll=poll full_view="True" no_indent="True" comments_expanded="True" %}
	
		
{% endblock content %}
